################################################################################################
# ╔══════════════════════════════════════════════════════════════════════════════════════════╗ #
# ║                        VERTIFLOW™ MQTT SECURITY BASELINE                                 ║ #
# ║                          File: config/mosquitto.conf                                     ║ #
# ║                          Ticket: TICKET-132                                             ║ #
# ║                     Maintainer: @Imrane (DevOps)                                         ║ #
# ║                     Reviewers : @Mounir, @MrZakaria                                      ║ #
# ╠══════════════════════════════════════════════════════════════════════════════════════════╣ #
# ║ PURPOSE: Harden the Eclipse Mosquitto broker used by the ESP32 telemetry fleet.          ║ #
# ║          Applies Zero-Trust defaults (no anonymous access, TLS-ready listeners,          ║ #
# ║          auditable logging) aligned with VertiFlow governance standards.                 ║ #
# ║                                                                                          ║ #
# ║ DEPLOYMENT NOTES:                                                                        ║ #
# ║   • Mount this file into the container at /mosquitto/config/mosquitto.conf               ║ #
# ║     (see docker-compose service "mosquitto").                                           ║ #
# ║   • Provide password & ACL files (default paths below) before switching off anonymous.   ║ #
# ║   • TLS certificates should be injected via the ./certs directory or secrets manager.    ║ #
# ╚══════════════════════════════════════════════════════════════════════════════════════════╝ #
################################################################################################

###############################################################################
# GLOBAL SETTINGS                                                             #
###############################################################################
user mosquitto
persistence true
persistence_location /mosquitto/data/
persistence_file mosquitto.db
per_listener_settings true
# ─────────────────────────────────────────────────────────────────────────────
# AUTHENTIFICATION - Désactivée temporairement pour le développement
# Décommentez ces lignes une fois les fichiers passwords/acls configurés
# ─────────────────────────────────────────────────────────────────────────────
# allow_anonymous false
# password_file /mosquitto/config/passwords
# acl_file /mosquitto/config/acls
# Persist inflight QoS1/2 messages frequently to avoid DLQ overflow
autosave_interval 600

# Tune throughput & memory usage
max_inflight_messages 100
max_queued_messages 2048
message_size_limit 0             # Unlimited payload (sensors may batch readings)
queue_qos0_messages false

###############################################################################
# LOGGING                                                                     #
###############################################################################
connection_messages true
log_timestamp true
log_dest stdout
log_dest file /mosquitto/log/mosquitto.log
log_type error
log_type warning
log_type notice
log_type information

###############################################################################
# LISTENER 1 — DEFAULT MQTT (LAN / DEV)                                       #
###############################################################################
listener 1883 0.0.0.0
protocol mqtt
allow_anonymous true            # Overridden in staging/prod once passwords distributed
max_connections 200
# Optional rate-limit to avoid DoS from rogue devices
max_keepalive 300

###############################################################################
# LISTENER 2 — TLS-ENFORCED MQTT (STAGING/PROD) - DÉSACTIVÉ                   #
# Décommentez une fois les certificats TLS générés dans config/mosquitto/certs #
###############################################################################
# listener 8883
# protocol mqtt
# cafile /mosquitto/certs/ca.crt
# certfile /mosquitto/certs/server.crt
# keyfile /mosquitto/certs/server.key
# require_certificate false
# allow_anonymous false
# use_identity_as_username false
# ciphers TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256
# tls_version tlsv1.2

###############################################################################
# LISTENER 3 — WEBSOCKET BRIDGE (FIELD DASHBOARD)                             #
###############################################################################
listener 9001
protocol websockets
allow_anonymous true             # Mode développement - Désactiver en production

###############################################################################
# BRIDGING / UPSTREAM EDGE                                                    #
###############################################################################
# Example: forward aggregated topics to cloud-regional broker
# connection vertiflow-backhaul
# address cloud-mqtt.vertiflow.ma:1883
# topic vertiflow/sensors/# both 2
# start_type automatic
# notifications true

###############################################################################
# DYNAMIC CONFIG INCLUDES                                                     #
###############################################################################
# Drop-in snippets (e.g., custom ACLs per facility)
# Disabled - conf.d directory not always available in Docker
# include_dir /mosquitto/config/conf.d

################################################################################################
# ╔══════════════════════════════════════════════════════════════════════════════════════════╗ #
# ║ END OF FILE — VertiFlow MQTT Secure Configuration                                        ║ #
# ║ Contact DevOps Guild before editing. Reference TICKET-132 for change control.             ║ #
# ╚══════════════════════════════════════════════════════════════════════════════════════════╝ #
################################################################################################
