# ============================================================================
# VERTIFLOW - Configuration Mosquitto Sécurisée
# ============================================================================
# MQTT Broker avec TLS et authentification
# ============================================================================

# Persistence
persistence true
persistence_location /mosquitto/data/

# Logging
log_dest file /mosquitto/log/mosquitto.log
log_type all
log_timestamp true
log_timestamp_format %Y-%m-%dT%H:%M:%S

# =============================================================================
# Listener Non-TLS (désactivé en production)
# =============================================================================
# listener 1883
# protocol mqtt

# =============================================================================
# Listener TLS (Port 8883)
# =============================================================================
listener 8883
protocol mqtt

# Certificats TLS
cafile /mosquitto/certs/ca.crt
certfile /mosquitto/certs/server.crt
keyfile /mosquitto/certs/server.key

# Exiger certificat client (mTLS) - optionnel
require_certificate false
# use_identity_as_username true

# Version TLS minimale
tls_version tlsv1.2

# =============================================================================
# Listener WebSocket TLS (Port 9001)
# =============================================================================
listener 9001
protocol websockets

cafile /mosquitto/certs/ca.crt
certfile /mosquitto/certs/server.crt
keyfile /mosquitto/certs/server.key

# =============================================================================
# Authentification
# =============================================================================
allow_anonymous false
password_file /mosquitto/config/passwd

# =============================================================================
# Autorisation ACL
# =============================================================================
acl_file /mosquitto/config/acl

# =============================================================================
# Limites de connexion
# =============================================================================
max_connections 1000
max_inflight_messages 100
max_queued_messages 1000

# Taille maximale des messages (256KB)
message_size_limit 262144

# Keepalive
max_keepalive 300

# =============================================================================
# Performance
# =============================================================================
# Interval de sauvegarde (secondes)
autosave_interval 60

# Retry interval pour les messages QoS > 0
retry_interval 20
