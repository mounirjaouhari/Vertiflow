---
config:
  layout: elk
title: VertiFlow Data Platform - Architecture v4 (Hybrid Cloud)
---
flowchart TB
    subgraph Z0["ğŸŒ ZONE 0 : EXTERNAL DATA APIs"]
        style Z0 fill:#e8eaf6,stroke:#3f51b5,stroke-width:2px
        API_WEATHER["â˜€ï¸ Open-Meteo Weather"]
        API_NASA["ğŸ›°ï¸ NASA POWER"]
        API_AIR["ğŸ’¨ OpenAQ Air Quality"]
    end
    subgraph SIM["ğŸ”Œ SIMULATEURS IoT"]
        style SIM fill:#e0f7fa,stroke:#00838f,stroke-width:2px
        MQTT_SIM["ğŸŒ¡ï¸ MQTT Simulator<br/>(mqtt_iot_simulator.py)"]
        KAFKA_SIM["ğŸ“Š Kafka Simulator<br/>(basil_telemetry_full)"]
    end
    subgraph Z1["ğŸ“¡ ZONE 1 : INGESTION & VALIDATION"]
        style Z1 fill:#e3f2fd,stroke:#1565c0,stroke-width:2px
        IOT_MQTT["ğŸŒ± ConsumeMQTT<br/>(vertiflow/farm/#)"]
        IOT_HTTP["ğŸ”— ListenHTTP<br/>(REST API)"]
        KAFKA_IN["ğŸ“¬ ConsumeKafka<br/>(basil_telemetry_full)"]
        VALIDATE["âœ… ValidateRecord"]
        MONITOR["ğŸ“Š Monitor Health"]
    end
    subgraph Z2["ğŸ”„ ZONE 2 : CONTEXTUALISATION"]
        style Z2 fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
        VPD_CALC["ğŸŒ¡ï¸ ExecuteScript<br/>(VPD Calculation)"]
        LOOKUP["ğŸ“š LookupRecord<br/>(Plant Recipes)"]
        KAFKA_OUT["ğŸ“¤ PublishKafka<br/>(Telemetry Enriched)"]
    end
    subgraph Z3["ğŸ’¾ ZONE 3 : PERSISTANCE"]
        style Z3 fill:#fff3e0,stroke:#ef6c00,stroke-width:2px
        
        subgraph LOCAL["ğŸ  Stockage Local"]
            style LOCAL fill:#e3f2fd,stroke:#1976d2
            CLICKHOUSE[["ğŸ“ˆ ClickHouse<br/>Analytics Temps RÃ©el"]]
            MONGODB[["ğŸ“ MongoDB<br/>Audit & Config"]]
        end
        
        subgraph CLOUD["â˜ï¸ Google Cloud Platform"]
            style CLOUD fill:#e8f5e9,stroke:#388e3c
            GCS[["ğŸ—„ï¸ GCS Data Lake<br/>Archive Brute"]]
            BIGQUERY[["ğŸ“Š BigQuery<br/>Analytics AvancÃ©e"]]
        end
        
        MERGE["ğŸ“¦ MergeContent<br/>(Batching)"]
    end
    subgraph Z4["ğŸ” ZONE 4 : RÃ‰TROACTION"]
        style Z4 fill:#fce4ec,stroke:#c2185b,stroke-width:2px
        KAFKA_FEED["ğŸ“¥ ConsumeKafka<br/>(vertiflow.feedback.commands)"]
        QUERY["ğŸ” QueryRecord<br/>(Anomalies)"]
        MQTT_OUT["ğŸ“¡ PublishMQTT<br/>(Commands)"]
    end
    subgraph Z5["ğŸ“ ZONE 5 : STATIC LOADERS"]
        style Z5 fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
        CSV_LOAD["ğŸ“„ GetFile CSV"]
        LAB_LOAD["ğŸ”¬ GetFile Lab"]
        RECIPE_LOAD["ğŸ“‹ GetFile Recipes"]
        SCRAPED["ğŸŒ ConsumeKafka<br/>(Scraped Data)"]
    end
    subgraph VIZ["ğŸ“Š VISUALISATION"]
        style VIZ fill:#fff9c4,stroke:#f9a825,stroke-width:2px
        GRAFANA["ğŸ“ˆ Grafana<br/>Dashboards Live"]
        LOOKER["ğŸ“Š Looker Studio<br/>(BigQuery)"]
    end
    subgraph DLQ["âš ï¸ DLQ - Dead Letter Queue"]
        style DLQ fill:#ffebee,stroke:#c62828
        DLQ_LOG["ğŸ“ DLQ Logger"]
    end
    MQTT_SIM ==>|"MQTT QoS1"| IOT_MQTT
    KAFKA_SIM ==>|"Stream"| KAFKA_IN
    API_WEATHER --> KAFKA_IN
    API_NASA --> KAFKA_IN
    API_AIR --> KAFKA_IN
    IOT_MQTT --> VALIDATE
    IOT_HTTP --> VALIDATE
    KAFKA_IN --> VALIDATE
    VALIDATE --> MONITOR
    MONITOR --> Z2
    MONITOR --> VPD_CALC
    VPD_CALC --> LOOKUP
    LOOKUP -->|"Enrichi avec targets"| KAFKA_OUT
    KAFKA_OUT --> MERGE
    KAFKA_OUT --> CLICKHOUSE
    KAFKA_OUT --> MONGODB
    MERGE --> GCS
    MERGE --> BIGQUERY
    CLICKHOUSE -->|"Anomalies dÃ©tectÃ©es"| QUERY
    MONGODB --> QUERY
    KAFKA_FEED --> QUERY
    QUERY -->|"Actions correctives"| MQTT_OUT
    MQTT_OUT -.->|"ğŸ”„ Control Commands"| IOT_MQTT
    CLICKHOUSE -.->|"PublishKafka"| KAFKA_FEED
    CSV_LOAD --> VALIDATE
    LAB_LOAD --> VALIDATE
    RECIPE_LOAD --> MONGODB
    SCRAPED --> VALIDATE
    CLICKHOUSE --> GRAFANA
    BIGQUERY --> LOOKER
    VALIDATE -.->|"âŒ Invalid"| DLQ_LOG
    classDef cloud fill:#a5d6a7,stroke:#2e7d32,stroke-width:2px
    classDef local fill:#90caf9,stroke:#1565c0,stroke-width:2px
    classDef kafka fill:#ffcc80,stroke:#ef6c00,stroke-width:2px
    
    class GCS,BIGQUERY cloud
    class CLICKHOUSE,MONGODB local
    class KAFKA_IN,KAFKA_OUT,KAFKA_FEED kafka