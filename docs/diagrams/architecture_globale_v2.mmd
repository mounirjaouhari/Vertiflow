```mermaid
---
title: VertiFlow - Architecture Globale Hybride v2
config:
  layout: elk
---
flowchart TB
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% SOURCES DE DONNÃ‰ES
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    subgraph SOURCES["ğŸ“¡ SOURCES - Multi-Canal"]
        direction LR
        IOT["ğŸŒ± Capteurs IoT<br/>(MQTT/Kafka)"]
        CAMERAS["ğŸ“· Vision IA<br/>(Images)"]
        APIS["ğŸ›°ï¸ APIs Externes<br/>(NASA/MÃ©tÃ©o/AirQ)"]
        LAB["ğŸ”¬ Saisie Labo<br/>(CSV/REST)"]
    end

    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% ORCHESTRATION NIFI
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    subgraph NIFI["ğŸ”„ APACHE NIFI - Orchestration"]
        direction TB
        N_VALID["âœ… Validation<br/>Schema + Z-Score"]
        N_ENRICH["âœ¨ Enrichissement<br/>VPD + Context"]
        N_BATCH["ğŸ“¦ Batching<br/>MergeContent"]
        N_ROUTE["ğŸ”€ Routage<br/>Multi-Destination"]
    end

    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% TRANSPORT KAFKA
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    subgraph KAFKA["ğŸ“¬ APACHE KAFKA - Transport"]
        K_TELEM["ğŸ“Š telemetry-enriched"]
        K_PRED["ğŸ¤– model-predictions"]
        K_CMD["âš™ï¸ farm-commands"]
    end

    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% STOCKAGE HYBRIDE
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    subgraph STORAGE["ğŸ’¾ STOCKAGE HYBRIDE"]
        direction TB
        
        subgraph LOCAL["ğŸ  Local (Temps RÃ©el)"]
            CH[("ğŸ“ˆ ClickHouse<br/>Analytics OLAP")]
            MG[("ğŸ“ MongoDB<br/>Documents")]
        end
        
        subgraph GCP["â˜ï¸ Google Cloud (Archive)"]
            GCS[("ğŸ—„ï¸ Cloud Storage<br/>Data Lake Raw")]
            BQ[("ğŸ“Š BigQuery<br/>Data Warehouse")]
        end
    end

    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% INTELLIGENCE ML
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    subgraph ML["ğŸ§  INTELLIGENCE ML"]
        direction LR
        ORACLE["ğŸ¯ Oracle<br/>Random Forest"]
        LSTM["â³ LSTM<br/>Time Series"]
        CORTEX["ğŸŒ€ Cortex<br/>Optimisation"]
    end

    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% VISUALISATION
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    subgraph VIZ["ğŸ“Š VISUALISATION"]
        direction LR
        GRAF["ğŸ“ˆ Grafana<br/>Temps RÃ©el"]
        LOOKER["ğŸ“Š Looker Studio<br/>Rapports"]
    end

    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% CONNEXIONS
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    %% Sources â†’ NiFi
    IOT ==>|"Stream"| N_VALID
    CAMERAS -->|"Batch"| N_VALID
    APIS ==>|"API Pull"| N_VALID
    LAB -->|"Upload"| N_VALID
    
    %% NiFi interne
    N_VALID --> N_ENRICH
    N_ENRICH --> N_BATCH
    N_BATCH --> N_ROUTE
    
    %% NiFi â†’ Kafka
    N_ROUTE ==>|"JSON"| K_TELEM
    
    %% Kafka â†’ Storage Local
    K_TELEM ==>|"Stream Insert"| CH
    K_TELEM -->|"Audit Log"| MG
    
    %% NiFi â†’ GCP (via Batch)
    N_ROUTE ==>|"NDJSON Batch"| GCS
    N_ROUTE ==>|"BigQuery Load"| BQ
    
    %% Storage â†’ ML
    CH --> ML
    BQ --> ML
    
    %% ML â†’ Kafka (Predictions)
    ML ==>|"Predictions"| K_PRED
    ML ==>|"Commands"| K_CMD
    
    %% Kafka â†’ IoT (Feedback)
    K_CMD -.->|"ğŸ”„ RÃ©troaction"| IOT
    
    %% Storage â†’ Viz
    CH ==>|"DirectQuery"| GRAF
    BQ ==>|"DirectQuery"| LOOKER
    K_TELEM -->|"Streaming"| GRAF
    
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% STYLES
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    style SOURCES fill:#e3f2fd,stroke:#1565c0,stroke-width:2px
    style NIFI fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
    style KAFKA fill:#fff3e0,stroke:#ef6c00,stroke-width:2px
    style STORAGE fill:#fafafa,stroke:#616161,stroke-width:2px
    style LOCAL fill:#e3f2fd,stroke:#1976d2,stroke-width:1px
    style GCP fill:#e8f5e9,stroke:#388e3c,stroke-width:1px
    style ML fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    style VIZ fill:#fff9c4,stroke:#f9a825,stroke-width:2px
    
    classDef stream stroke:#d32f2f,stroke-width:3px
    classDef batch stroke:#1976d2,stroke-width:2px,stroke-dasharray:5 5
    
    linkStyle 0 stroke:#d32f2f,stroke-width:3px
    linkStyle 2 stroke:#d32f2f,stroke-width:3px
    linkStyle 6 stroke:#d32f2f,stroke-width:3px
    linkStyle 7 stroke:#d32f2f,stroke-width:3px
    linkStyle 10 stroke:#2e7d32,stroke-width:3px
    linkStyle 11 stroke:#2e7d32,stroke-width:3px
```
