```mermaid
---
title: VertiFlow Data Platform - Architecture 7 Couches (Hybrid Cloud + AI Agents)
config:
  layout: elk
---
flowchart TB
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% COUCHE 1 : PHYSIQUE IoT
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    subgraph C1["ğŸ”Œ COUCHE 1 : PHYSIQUE IoT"]
        direction LR
        CAPTEURS_ENV["ğŸŒ¡ï¸ Capteurs Environnement<br/>(Temp, HumiditÃ©, CO2)"]
        CAPTEURS_HYDRO["ğŸ’§ Capteurs Hydroponique<br/>(pH, EC, DO)"]
        CAPTEURS_LIGHT["ğŸ’¡ Capteurs LumiÃ¨re<br/>(PPFD, DLI, Spectre)"]
        VISION["ğŸ“· Vision IA<br/>(CamÃ©ras)"]
        APIS_EXT["ğŸ›°ï¸ APIs Externes<br/>(NASA/OpenMeteo/OpenAQ)"]
    end
    
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% COUCHE 2 : INGESTION
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    subgraph C2["ğŸ“¡ COUCHE 2 : INGESTION"]
        direction TB
        
        subgraph MQTT_LAYER["ğŸ“¶ MQTT Broker"]
            MQTT["ğŸ”— Eclipse Mosquitto<br/>(vertiflow/farm/#)"]
        end
        
        subgraph NIFI_LAYER["ğŸ”„ Apache NiFi (50 Processeurs)"]
            N_Z1["ğŸ“¡ Zone 1 - Ingestion<br/>(ConsumeMQTT, ListenHTTP)"]
            N_Z2["ğŸ”„ Zone 2 - Contextualisation<br/>(VPD Calculation)"]
            N_Z5["ğŸ“ Zone 5 - Static Loaders<br/>(CSV, Recipes, Lab)"]
            N_Z0["ğŸŒ Zone 0 - External APIs<br/>(Weather, Air, NASA)"]
        end
    end
    
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% COUCHE 3 : STREAMING
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    subgraph C3["ğŸ“¬ COUCHE 3 : STREAMING"]
        direction LR
        K_TELEMETRY["ğŸ“Š basil_telemetry_full<br/>(DonnÃ©es Capteurs)"]
        K_FEEDBACK["ğŸ” vertiflow.feedback<br/>(Commands)"]
        K_EXTERNAL["ğŸŒ external_data<br/>(APIs Externes)"]
        K_ML["ğŸ¤– ml_predictions<br/>(ModÃ¨les ML)"]
    end
    
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% COUCHE 4 : STOCKAGE HYBRID CLOUD
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    subgraph C4["ğŸ’¾ COUCHE 4 : STOCKAGE"]
        direction TB
        
        subgraph LOCAL["ğŸ  On-Premise"]
            CLICK[("ğŸ“ˆ ClickHouse<br/>Time-Series Analytics<br/>157 colonnes Golden Record")]
            MONGO[("ğŸ“ MongoDB<br/>Documents & Audit<br/>plant_recipes, live_state")]
        end
        
        subgraph CLOUD["â˜ï¸ Google Cloud Platform"]
            GCS[("ğŸ—„ï¸ GCS Data Lake<br/>Archive Parquet/JSON")]
            BIGQUERY[("ğŸ“Š BigQuery<br/>Analytics ML Ready")]
        end
    end
    
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% COUCHE 5 : INTELLIGENCE ML
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    subgraph C5["ğŸ§  COUCHE 5 : INTELLIGENCE ML"]
        direction TB
        
        subgraph ALGOS["âš¡ Algorithmes Temps RÃ©el"]
            ALGO_ORACLE["ğŸ”® Oracle<br/>(PrÃ©diction Rendement)"]
            ALGO_CLASSIFIER["ğŸ·ï¸ Classifier<br/>(QualitÃ©/Anomalies)"]
            ALGO_CORTEX["ğŸ§  Cortex<br/>(Z-Score & Tendances)"]
        end
        
        subgraph AI_AGENTS["ğŸ¤– AI Agents (Agri-Copilot)"]
            GEMINI["âœ¨ Google Gemini<br/>(NL â†’ SQL)"]
            VERTEX["ğŸš€ Vertex AI<br/>(ML Models)"]
            STREAMLIT["ğŸ’¬ Streamlit UI<br/>(Chat FR/EN/AR)"]
            FASTAPI["âš¡ FastAPI<br/>(REST API)"]
        end
    end
    
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% COUCHE 6 : RÃ‰TROACTION (FEEDBACK LOOP)
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    subgraph C6["ğŸ” COUCHE 6 : RÃ‰TROACTION"]
        direction TB
        
        subgraph NIFI_FEEDBACK["ğŸ”„ NiFi Zone 4"]
            N_Z4["ğŸ” Zone 4 - Feedback<br/>(11 Processeurs)"]
            ZSCORE["ğŸ“Š Z-Score Validator"]
            MQTT_OUT["ğŸ“¡ PublishMQTT<br/>(Commandes IoT)"]
        end
        
        subgraph ACTIONS["âš¡ Actions Correctives"]
            CMD_HVAC["ğŸŒ¡ï¸ Ajustement HVAC"]
            CMD_NUTRIENT["ğŸ’§ Dosage Nutriments"]
            CMD_LIGHT["ğŸ’¡ Spectre LED"]
            CMD_IRRIGATION["ğŸš¿ Irrigation"]
        end
    end
    
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% COUCHE 7 : VISUALISATION
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    subgraph C7["ğŸ“Š COUCHE 7 : VISUALISATION"]
        direction LR
        GRAFANA["ğŸ“ˆ Grafana<br/>Dashboards Live<br/>(ClickHouse)"]
        LOOKER["ğŸ“Š Looker Studio<br/>Business Analytics<br/>(BigQuery)"]
        PLOTLY["ğŸ“‰ Plotly Charts<br/>(Agent Generated)"]
    end
    
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% CONNEXIONS COUCHE 1 â†’ COUCHE 2
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    CAPTEURS_ENV ==>|"MQTT QoS1"| MQTT
    CAPTEURS_HYDRO ==>|"MQTT QoS1"| MQTT
    CAPTEURS_LIGHT ==>|"MQTT QoS1"| MQTT
    VISION --> N_Z1
    APIS_EXT --> N_Z0
    MQTT --> N_Z1
    
    %% NiFi interne
    N_Z0 --> N_Z1
    N_Z1 --> N_Z2
    N_Z5 --> N_Z2
    
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% CONNEXIONS COUCHE 2 â†’ COUCHE 3
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    N_Z2 --> K_TELEMETRY
    N_Z0 --> K_EXTERNAL
    N_Z5 --> K_TELEMETRY
    
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% CONNEXIONS COUCHE 3 â†’ COUCHE 4
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    K_TELEMETRY --> CLICK
    K_TELEMETRY --> MONGO
    K_TELEMETRY --> GCS
    K_EXTERNAL --> BIGQUERY
    GCS --> BIGQUERY
    
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% CONNEXIONS COUCHE 4 â†’ COUCHE 5
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    CLICK --> ALGO_CORTEX
    CLICK --> ALGO_CLASSIFIER
    BIGQUERY --> ALGO_ORACLE
    BIGQUERY --> VERTEX
    VERTEX --> GEMINI
    CLICK --> GEMINI
    BIGQUERY --> GEMINI
    GEMINI --> STREAMLIT
    GEMINI --> FASTAPI
    
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% CONNEXIONS COUCHE 5 â†’ COUCHE 6
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    ALGO_CORTEX --> N_Z4
    ALGO_CLASSIFIER --> N_Z4
    ALGO_ORACLE -.->|"Predictions"| K_ML
    K_ML --> N_Z4
    N_Z4 --> ZSCORE
    ZSCORE --> MQTT_OUT
    N_Z4 --> K_FEEDBACK
    
    %% Actions correctives
    MQTT_OUT --> CMD_HVAC
    MQTT_OUT --> CMD_NUTRIENT
    MQTT_OUT --> CMD_LIGHT
    MQTT_OUT --> CMD_IRRIGATION
    
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% CONNEXIONS COUCHE 6 â†’ COUCHE 1 (Boucle FermÃ©e)
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    CMD_HVAC -.->|"ğŸ”„ Control"| CAPTEURS_ENV
    CMD_NUTRIENT -.->|"ğŸ”„ Control"| CAPTEURS_HYDRO
    CMD_LIGHT -.->|"ğŸ”„ Control"| CAPTEURS_LIGHT
    
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% CONNEXIONS COUCHE 4/5 â†’ COUCHE 7
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    CLICK --> GRAFANA
    BIGQUERY --> LOOKER
    STREAMLIT --> PLOTLY
    FASTAPI --> PLOTLY

    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% STYLES PAR COUCHE
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    style C1 fill:#e0f7fa,stroke:#00838f,stroke-width:3px
    style C2 fill:#e3f2fd,stroke:#1565c0,stroke-width:3px
    style C3 fill:#fff3e0,stroke:#ef6c00,stroke-width:3px
    style C4 fill:#f5f5f5,stroke:#616161,stroke-width:3px
    style C5 fill:#fce4ec,stroke:#c2185b,stroke-width:3px
    style C6 fill:#e8f5e9,stroke:#2e7d32,stroke-width:3px
    style C7 fill:#fff9c4,stroke:#f9a825,stroke-width:3px
    
    style LOCAL fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
    style CLOUD fill:#e8f5e9,stroke:#388e3c,stroke-width:2px
    style MQTT_LAYER fill:#b3e5fc,stroke:#0288d1,stroke-width:1px
    style NIFI_LAYER fill:#bbdefb,stroke:#1976d2,stroke-width:1px
    style ALGOS fill:#f8bbd9,stroke:#c2185b,stroke-width:1px
    style AI_AGENTS fill:#e1bee7,stroke:#8e24aa,stroke-width:1px
    style NIFI_FEEDBACK fill:#c8e6c9,stroke:#388e3c,stroke-width:1px
    style ACTIONS fill:#dcedc8,stroke:#689f38,stroke-width:1px
    
    %% Classes de couleur
    CLICK:::Class_Click
    MONGO:::Class_Mongo
    K_TELEMETRY:::Class_Kafka
    K_FEEDBACK:::Class_Kafka
    K_EXTERNAL:::Class_Kafka
    K_ML:::Class_Kafka
    GCS:::Class_Cloud
    BIGQUERY:::Class_Cloud
    VERTEX:::Class_Cloud
    GEMINI:::Class_AI
    STREAMLIT:::Class_Agent
    FASTAPI:::Class_Agent
    
    classDef Class_Mongo fill:#00C853,stroke:#333,color:white
    classDef Class_Click fill:#FFD600,stroke:#333,color:black
    classDef Class_Kafka fill:#FF9800,stroke:#333,color:white
    classDef Class_Cloud fill:#4285F4,stroke:#333,color:white
    classDef Class_AI fill:#EA4335,stroke:#333,color:white
    classDef Class_Agent fill:#9C27B0,stroke:#333,color:white
```
