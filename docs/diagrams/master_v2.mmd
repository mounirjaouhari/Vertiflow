---
title: VertiFlow Data Platform - Architecture Master v2 (Hybrid Cloud + AI Agents)
config:
  layout: elk
---
flowchart TB
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% 1. SOURCES DE DONNÃ‰ES
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    subgraph SOURCES["ğŸ“¡ 1. SOURCES"]
        direction TB
        IOT["ğŸŒ± Capteurs IoT<br/>(MQTT/Kafka)"]
        VISION["ğŸ“· Vision IA<br/>(CamÃ©ras)"]
        APIS["ğŸ›°ï¸ APIs Externes<br/>(NASA/OpenMeteo/OpenAQ)"]
        LAB["ğŸ”¬ Saisie Labo<br/>(CSV/Fichiers)"]
    end
    
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% 2. APACHE NIFI - 50 PROCESSEURS
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    subgraph NIFI["ğŸ”„ 2. APACHE NIFI (50 Processeurs)"]
        direction TB
        N_INGEST["ğŸ“¡ Zone 1<br/>Ingestion & Validation"]
        N_ENRICH["ğŸ”„ Zone 2<br/>Contextualisation (VPD)"]
        N_PERSIST["ğŸ’¾ Zone 3<br/>Persistance Multi-Cloud"]
        N_FEEDBACK["ğŸ” Zone 4<br/>RÃ©troaction & Alertes"]
        N_STATIC["ğŸ“ Zone 5<br/>Static Data Loaders"]
    end
    
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% 3. APACHE KAFKA - EVENT BUS
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    subgraph KAFKA["ğŸ“¬ 3. APACHE KAFKA"]
        direction LR
        K_TELEMETRY["ğŸ“Š basil_telemetry_full"]
        K_FEEDBACK["ğŸ” vertiflow.feedback"]
        K_EXTERNAL["ğŸŒ external_data"]
    end
    
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% 4. STOCKAGE HYBRID CLOUD
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    subgraph STORAGE["ğŸ’¾ 4. STOCKAGE HYBRID CLOUD"]
        direction TB
        
        subgraph LOCAL["ğŸ  Stockage Local (On-Premise)"]
            MONGO[("âš¡ MongoDB<br/>Documents & Audit")]
            CLICK[("ğŸ“ˆ ClickHouse<br/>Time-Series Analytics<br/>157 colonnes Golden Record")]
        end
        
        subgraph CLOUD["â˜ï¸ Google Cloud Platform"]
            GCS[("ğŸ—„ï¸ GCS Data Lake<br/>Archive & Raw Data")]
            BIGQUERY[("ğŸ“Š BigQuery<br/>Analytics AvancÃ©e<br/>ML Ready")]
            VERTEX["ğŸ¤– Vertex AI<br/>ML Models"]
        end
    end
    
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% 5. AI AGENTS - AGRI-COPILOT
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    subgraph AGENTS["ğŸ¤– 5. AI AGENTS (Agri-Copilot)"]
        direction TB
        
        subgraph COPILOT["ğŸŒ¿ Agri-Copilot Chat"]
            STREAMLIT["ğŸ’¬ Interface Streamlit<br/>(Chat Multilingue FR/EN/AR)"]
            GEMINI["âœ¨ Google Gemini<br/>(Natural Language â†’ SQL)"]
        end
        
        subgraph COPILOT_PRO["ğŸš€ Agri-Copilot Pro API"]
            FASTAPI["âš¡ FastAPI Server<br/>(REST API)"]
            QUERY_SVC["ğŸ” Query Service<br/>(SQL Generation)"]
            AUTH["ğŸ” Auth & RBAC<br/>(JWT + RÃ´les)"]
        end
    end
    
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% 6. INTELLIGENCE & ML
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    subgraph INTELLIGENCE["ğŸ§  6. INTELLIGENCE"]
        direction TB
        ALGO_REFLEXE["ğŸš¨ Algo RÃ©flexe<br/>(Z-Score Temps RÃ©el)"]
        ALGO_STAT["ğŸ“Š Algo Statistique<br/>(Tendances)"]
        ALGO_PREDICT["ğŸ¤– Algo PrÃ©dictif<br/>(Rendement/QualitÃ©)"]
    end
    
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% 7. VISUALISATION
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    subgraph VIZ["ğŸ“Š 7. VISUALISATION"]
        direction LR
        GRAFANA["ğŸ“ˆ Grafana<br/>Dashboards Live"]
        LOOKER["ğŸ“Š Looker Studio<br/>Business Analytics"]
        PLOTLY["ğŸ“‰ Plotly Charts<br/>(Agent Generated)"]
    end
    
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% CONNEXIONS - Sources â†’ NiFi
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    IOT ==>|"MQTT QoS1"| N_INGEST
    VISION --> N_INGEST
    APIS --> N_INGEST
    LAB --> N_STATIC
    
    %% NiFi interne
    N_INGEST --> N_ENRICH
    N_ENRICH --> N_PERSIST
    N_PERSIST --> N_FEEDBACK
    N_STATIC --> N_PERSIST
    
    %% NiFi â†’ Kafka
    N_ENRICH --> K_TELEMETRY
    N_FEEDBACK --> K_FEEDBACK
    APIS --> K_EXTERNAL
    
    %% Kafka â†’ Stockage
    K_TELEMETRY --> MONGO
    K_TELEMETRY --> CLICK
    K_TELEMETRY --> GCS
    K_TELEMETRY --> BIGQUERY
    
    %% Cloud Integration
    GCS --> BIGQUERY
    BIGQUERY --> VERTEX
    VERTEX --> ALGO_PREDICT
    
    %% Intelligence
    MONGO <--> ALGO_REFLEXE
    CLICK <--> ALGO_STAT
    K_TELEMETRY --> ALGO_PREDICT
    ALGO_PREDICT -.->|"Predictions"| K_FEEDBACK
    ALGO_REFLEXE -.->|"ğŸ”„ ContrÃ´le IoT"| IOT
    
    %% AI Agents Connections
    GEMINI --> QUERY_SVC
    QUERY_SVC --> CLICK
    QUERY_SVC --> BIGQUERY
    STREAMLIT --> GEMINI
    FASTAPI --> QUERY_SVC
    AUTH --> FASTAPI
    
    %% Visualisation
    CLICK --> GRAFANA
    BIGQUERY --> LOOKER
    QUERY_SVC --> PLOTLY
    STREAMLIT --> PLOTLY
    
    %% Feedback Loop
    K_FEEDBACK -->|"Commands"| N_FEEDBACK
    N_FEEDBACK -.->|"MQTT Commands"| IOT

    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% STYLES
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    MONGO:::Class_Mongo
    CLICK:::Class_Click
    K_TELEMETRY:::Class_Kafka
    K_FEEDBACK:::Class_Kafka
    K_EXTERNAL:::Class_Kafka
    GCS:::Class_Cloud
    BIGQUERY:::Class_Cloud
    VERTEX:::Class_Cloud
    GEMINI:::Class_AI
    STREAMLIT:::Class_Agent
    FASTAPI:::Class_Agent
    
    classDef Class_Mongo fill:#00C853,stroke:#333,color:white
    classDef Class_Click fill:#FFD600,stroke:#333,color:black
    classDef Class_Kafka fill:#FF9800,stroke:#333,color:white
    classDef Class_NiFi fill:#03A9F4,stroke:#333,color:white
    classDef Class_Cloud fill:#4285F4,stroke:#333,color:white
    classDef Class_AI fill:#EA4335,stroke:#333,color:white
    classDef Class_Agent fill:#9C27B0,stroke:#333,color:white
    
    style SOURCES fill:#e0f7fa,stroke:#00838f,stroke-width:2px
    style NIFI fill:#e3f2fd,stroke:#1565c0,stroke-width:2px
    style KAFKA fill:#fff3e0,stroke:#ef6c00,stroke-width:2px
    style STORAGE fill:#f5f5f5,stroke:#616161,stroke-width:2px
    style LOCAL fill:#e3f2fd,stroke:#1976d2,stroke-width:1px
    style CLOUD fill:#e8f5e9,stroke:#388e3c,stroke-width:1px
    style AGENTS fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    style COPILOT fill:#e1bee7,stroke:#8e24aa,stroke-width:1px
    style COPILOT_PRO fill:#ce93d8,stroke:#7b1fa2,stroke-width:1px
    style INTELLIGENCE fill:#fce4ec,stroke:#c2185b,stroke-width:2px
    style VIZ fill:#fff9c4,stroke:#f9a825,stroke-width:2px