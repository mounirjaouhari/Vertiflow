{
  "annotations": { "list": [] },
  "description": "üåø Tableau de bord complet de surveillance du r√©seau IoT VertiFlow. Visualisez en temps r√©el l'√©tat de sant√©, la localisation g√©ographique et les performances de tous vos capteurs r√©partis par zones et racks de culture.",
  "editable": true,
  "fiscalYearStartMonth": 0,
  "graphTooltip": 2,
  "uid": "vertiflow-iot-health",
  "id": null,
  "links": [],
  "liveNow": true,
  "panels": [
    {
      "type": "text",
      "title": "",
      "gridPos": { "h": 2, "w": 24, "x": 0, "y": 0 },
      "options": {
        "mode": "markdown",
        "content": "# üì° VERTIFLOW IoT - Centre de Contr√¥le des Capteurs\n**Surveillance Temps R√©el** | Sant√© du R√©seau | Localisation G√©ographique | 22 Capteurs Actifs"
      }
    },
    {
      "type": "row",
      "title": "üìä Vue d'Ensemble du R√©seau IoT",
      "gridPos": { "h": 1, "w": 24, "x": 0, "y": 2 },
      "collapsed": false
    },
    {
      "type": "stat",
      "title": "üì° Total Capteurs",
      "description": "Nombre total de capteurs IoT d√©ploy√©s dans l'infrastructure VertiFlow. Ces capteurs mesurent en continu les param√®tres environnementaux et nutritifs.",
      "gridPos": { "h": 4, "w": 4, "x": 0, "y": 3 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "aeb1b4ee-1f88-42c3-a35a-f594cac90e00" },
      "targets": [{ "rawSql": "SELECT count(DISTINCT sensor_id) as total FROM vertiflow.iot_sensors", "refId": "A", "format": 1 }],
      "fieldConfig": { 
        "defaults": { 
          "unit": "short", 
          "displayName": "Capteurs",
          "color": { "mode": "thresholds" }, 
          "thresholds": { "steps": [{ "color": "blue", "value": null }] } 
        } 
      },
      "options": { "colorMode": "value", "graphMode": "area", "textMode": "auto" }
    },
    {
      "type": "stat",
      "title": "üü¢ En Ligne",
      "description": "Capteurs actuellement connect√©s et fonctionnels. Ils transmettent leurs mesures en temps r√©el vers la plateforme.",
      "gridPos": { "h": 4, "w": 4, "x": 4, "y": 3 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "aeb1b4ee-1f88-42c3-a35a-f594cac90e00" },
      "targets": [{ "rawSql": "SELECT count(DISTINCT sensor_id) as en_ligne FROM vertiflow.iot_sensors WHERE status = 'online'", "refId": "A", "format": 1 }],
      "fieldConfig": { 
        "defaults": { 
          "unit": "short", 
          "displayName": "Connect√©s",
          "color": { "fixedColor": "green", "mode": "fixed" } 
        } 
      },
      "options": { "colorMode": "background", "graphMode": "area" }
    },
    {
      "type": "stat",
      "title": "üü° Avertissement",
      "description": "Capteurs pr√©sentant des anomalies mineures (signal faible, batterie basse, d√©rive de mesure). Intervention pr√©ventive recommand√©e.",
      "gridPos": { "h": 4, "w": 4, "x": 8, "y": 3 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "aeb1b4ee-1f88-42c3-a35a-f594cac90e00" },
      "targets": [{ "rawSql": "SELECT count(DISTINCT sensor_id) as avertissement FROM vertiflow.iot_sensors WHERE status = 'warning'", "refId": "A", "format": 1 }],
      "fieldConfig": { 
        "defaults": { 
          "unit": "short", 
          "displayName": "Avertissements",
          "color": { "fixedColor": "yellow", "mode": "fixed" } 
        } 
      },
      "options": { "colorMode": "background", "graphMode": "area" }
    },
    {
      "type": "stat",
      "title": "üî¥ Hors Ligne",
      "description": "Capteurs non connect√©s ou ne transmettant plus de donn√©es. V√©rification physique n√©cessaire (alimentation, connexion r√©seau).",
      "gridPos": { "h": 4, "w": 4, "x": 12, "y": 3 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "aeb1b4ee-1f88-42c3-a35a-f594cac90e00" },
      "targets": [{ "rawSql": "SELECT count(DISTINCT sensor_id) as hors_ligne FROM vertiflow.iot_sensors WHERE status = 'offline'", "refId": "A", "format": 1 }],
      "fieldConfig": { 
        "defaults": { 
          "unit": "short", 
          "displayName": "D√©connect√©s",
          "color": { "fixedColor": "red", "mode": "fixed" } 
        } 
      },
      "options": { "colorMode": "background", "graphMode": "area" }
    },
    {
      "type": "stat",
      "title": "‚õî Erreur",
      "description": "Capteurs en √©tat d'erreur critique n√©cessitant une intervention imm√©diate.",
      "gridPos": { "h": 4, "w": 4, "x": 16, "y": 3 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "aeb1b4ee-1f88-42c3-a35a-f594cac90e00" },
      "targets": [{ "rawSql": "SELECT count(DISTINCT sensor_id) as erreur FROM vertiflow.iot_sensors WHERE status = 'error'", "refId": "A", "format": 1 }],
      "fieldConfig": { 
        "defaults": { 
          "unit": "short", 
          "displayName": "Erreurs",
          "color": { "fixedColor": "dark-red", "mode": "fixed" } 
        } 
      },
      "options": { "colorMode": "background", "graphMode": "area" }
    },
    {
      "type": "stat",
      "title": "üîß Maintenance",
      "description": "Capteurs en cours de maintenance programm√©e (calibration, mise √† jour firmware, nettoyage).",
      "gridPos": { "h": 4, "w": 4, "x": 20, "y": 3 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "aeb1b4ee-1f88-42c3-a35a-f594cac90e00" },
      "targets": [{ "rawSql": "SELECT count(DISTINCT sensor_id) as maintenance FROM vertiflow.iot_sensors WHERE status = 'maintenance'", "refId": "A", "format": 1 }],
      "fieldConfig": { 
        "defaults": { 
          "unit": "short", 
          "displayName": "Maintenance",
          "color": { "fixedColor": "orange", "mode": "fixed" } 
        } 
      },
      "options": { "colorMode": "background", "graphMode": "area" }
    },
    {
      "type": "gauge",
      "title": "üíö Indice de Sant√© Global",
      "description": "Score de sant√© moyen de l'ensemble du r√©seau IoT (0-100%). Calcul√© √† partir de la qualit√© du signal, du niveau de batterie et de la fiabilit√© des mesures. Objectif: >90%.",
      "gridPos": { "h": 6, "w": 6, "x": 0, "y": 7 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "aeb1b4ee-1f88-42c3-a35a-f594cac90e00" },
      "targets": [{ "rawSql": "SELECT round(avg(health_score), 1) as sante_globale FROM vertiflow.iot_sensors WHERE status != 'offline'", "refId": "A", "format": 1 }],
      "fieldConfig": { 
        "defaults": { 
          "unit": "percent", 
          "min": 0, 
          "max": 100, 
          "displayName": "Sant√© R√©seau",
          "thresholds": { 
            "steps": [
              { "color": "red", "value": null }, 
              { "color": "orange", "value": 50 }, 
              { "color": "yellow", "value": 75 }, 
              { "color": "green", "value": 90 }
            ] 
          } 
        } 
      },
      "options": { "showThresholdLabels": true, "showThresholdMarkers": true }
    },
    {
      "type": "gauge",
      "title": "üîã Niveau Batterie Moyen",
      "description": "Autonomie moyenne des batteries des capteurs sans fil. En dessous de 30%, planifier un remplacement. Les capteurs filaires affichent 0%.",
      "gridPos": { "h": 6, "w": 6, "x": 6, "y": 7 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "aeb1b4ee-1f88-42c3-a35a-f594cac90e00" },
      "targets": [{ "rawSql": "SELECT round(avg(battery_level), 1) as batterie_moyenne FROM vertiflow.iot_sensors WHERE battery_level > 0", "refId": "A", "format": 1 }],
      "fieldConfig": { 
        "defaults": { 
          "unit": "percent", 
          "min": 0, 
          "max": 100, 
          "displayName": "Batterie",
          "thresholds": { 
            "steps": [
              { "color": "red", "value": null }, 
              { "color": "orange", "value": 30 }, 
              { "color": "yellow", "value": 60 }, 
              { "color": "green", "value": 80 }
            ] 
          } 
        } 
      },
      "options": { "showThresholdLabels": true, "showThresholdMarkers": true }
    },
    {
      "type": "piechart",
      "title": "üìä R√©partition par √âtat de Connexion",
      "description": "Distribution des capteurs selon leur √©tat de connexion actuel. Un r√©seau sain doit avoir >90% de capteurs en ligne.",
      "gridPos": { "h": 6, "w": 6, "x": 12, "y": 7 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "aeb1b4ee-1f88-42c3-a35a-f594cac90e00" },
      "targets": [{ 
        "rawSql": "SELECT multiIf(status = 'online', 'üü¢ En ligne', status = 'offline', 'üî¥ Hors ligne', status = 'warning', 'üü° Avertissement', status = 'error', '‚õî Erreur', 'üîß Maintenance') as Etat, count() as Nombre FROM vertiflow.iot_sensors GROUP BY status ORDER BY Nombre DESC", 
        "refId": "A", 
        "format": 1 
      }],
      "transformations": [
        { "id": "rowsToFields", "options": { "mappings": [ { "fieldName": "Etat", "handlerKey": "field.name" }, { "fieldName": "Nombre", "handlerKey": "field.value" } ] } }
      ],
      "fieldConfig": { 
        "defaults": { "color": { "mode": "palette-classic" } }, 
        "overrides": [
          { "matcher": { "id": "byName", "options": "üü¢ En ligne" }, "properties": [{ "id": "color", "value": { "fixedColor": "green", "mode": "fixed" } }] }, 
          { "matcher": { "id": "byName", "options": "üî¥ Hors ligne" }, "properties": [{ "id": "color", "value": { "fixedColor": "red", "mode": "fixed" } }] }, 
          { "matcher": { "id": "byName", "options": "üü° Avertissement" }, "properties": [{ "id": "color", "value": { "fixedColor": "yellow", "mode": "fixed" } }] }, 
          { "matcher": { "id": "byName", "options": "‚õî Erreur" }, "properties": [{ "id": "color", "value": { "fixedColor": "dark-red", "mode": "fixed" } }] }, 
          { "matcher": { "id": "byName", "options": "üîß Maintenance" }, "properties": [{ "id": "color", "value": { "fixedColor": "orange", "mode": "fixed" } }] }
        ] 
      },
      "options": { 
        "legend": { "displayMode": "table", "placement": "right", "values": ["value", "percent"] }, 
        "pieType": "donut",
        "displayLabels": ["name", "percent"]
      }
    },
    {
      "type": "piechart",
      "title": "üî¨ Classification par Domaine Fonctionnel",
      "description": "Cat√©gorisation professionnelle des capteurs selon les 4 piliers de contr√¥le en agriculture verticale: üå°Ô∏è Atmosph√©rique (climat), üíß Hydroponique (solution), üß¨ Nutritionnel (NPK), ‚òÄÔ∏è Photonique (lumi√®re).",
      "gridPos": { "h": 6, "w": 6, "x": 18, "y": 7 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "aeb1b4ee-1f88-42c3-a35a-f594cac90e00" },
      "targets": [{ 
        "rawSql": "SELECT multiIf(sensor_type IN ('Temperature', 'Humidity', 'CO2'), 'üå°Ô∏è Atmosph√©rique', sensor_type IN ('EC', 'pH'), 'üíß Hydroponique', sensor_type IN ('Nutrient_N', 'Nutrient_P', 'Nutrient_K'), 'üß¨ Nutritionnel', sensor_type = 'Light_PPFD', '‚òÄÔ∏è Photonique', 'üì° Autre') as Domaine, count() as Capteurs FROM vertiflow.iot_sensors GROUP BY Domaine ORDER BY Capteurs DESC", 
        "refId": "A", 
        "format": 1 
      }],
      "transformations": [
        { "id": "rowsToFields", "options": { "mappings": [ { "fieldName": "Domaine", "handlerKey": "field.name" }, { "fieldName": "Capteurs", "handlerKey": "field.value" } ] } }
      ],
      "fieldConfig": { 
        "defaults": { "color": { "mode": "palette-classic" } },
        "overrides": [
          { "matcher": { "id": "byName", "options": "üå°Ô∏è Atmosph√©rique" }, "properties": [{ "id": "color", "value": { "fixedColor": "orange", "mode": "fixed" } }] },
          { "matcher": { "id": "byName", "options": "üíß Hydroponique" }, "properties": [{ "id": "color", "value": { "fixedColor": "blue", "mode": "fixed" } }] },
          { "matcher": { "id": "byName", "options": "üß¨ Nutritionnel" }, "properties": [{ "id": "color", "value": { "fixedColor": "green", "mode": "fixed" } }] },
          { "matcher": { "id": "byName", "options": "‚òÄÔ∏è Photonique" }, "properties": [{ "id": "color", "value": { "fixedColor": "yellow", "mode": "fixed" } }] }
        ]
      },
      "options": { 
        "legend": { "displayMode": "table", "placement": "right", "values": ["value", "percent"] }, 
        "pieType": "donut",
        "displayLabels": ["name", "value"]
      }
    },
    {
      "type": "row",
      "title": "üî¨ D√©tail par Type de Capteur",
      "gridPos": { "h": 1, "w": 24, "x": 0, "y": 13 },
      "collapsed": false
    },
    {
      "type": "bargauge",
      "title": "üìà R√©partition D√©taill√©e par Type de Capteur",
      "description": "Nombre de capteurs pour chaque type de mesure d√©ploy√© dans l'installation. Les capteurs CO2 et Temp√©rature sont les plus nombreux pour un contr√¥le climatique optimal.",
      "gridPos": { "h": 6, "w": 12, "x": 0, "y": 14 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "aeb1b4ee-1f88-42c3-a35a-f594cac90e00" },
      "targets": [{ 
        "rawSql": "SELECT multiIf(sensor_type = 'Temperature', 'üå°Ô∏è Temp√©rature', sensor_type = 'Humidity', 'üí® Humidit√©', sensor_type = 'CO2', 'ü´ß CO2', sensor_type = 'EC', '‚ö° Conductivit√© (EC)', sensor_type = 'pH', 'üß™ pH', sensor_type = 'Light_PPFD', '‚òÄÔ∏è Lumi√®re PPFD', sensor_type = 'Nutrient_N', 'ü•¨ Azote (N)', sensor_type = 'Nutrient_P', 'üåø Phosphore (P)', sensor_type = 'Nutrient_K', 'üçÉ Potassium (K)', sensor_type) as Type_Capteur, count() as Nombre FROM vertiflow.iot_sensors GROUP BY sensor_type ORDER BY Nombre DESC", 
        "refId": "A", 
        "format": 1 
      }],
      "transformations": [
        { "id": "rowsToFields", "options": { "mappings": [ { "fieldName": "Type_Capteur", "handlerKey": "field.name" }, { "fieldName": "Nombre", "handlerKey": "field.value" } ] } }
      ],
      "fieldConfig": { 
        "defaults": { 
          "unit": "short", 
          "color": { "mode": "palette-classic" },
          "thresholds": { "steps": [{ "color": "blue", "value": null }] }
        }
      },
      "options": { "orientation": "horizontal", "displayMode": "gradient", "showUnfilled": true }
    },
    {
      "type": "table",
      "title": "üìã Performance par Type & Domaine",
      "description": "Performance et √©tat de sant√© des capteurs group√©s par type de mesure et domaine fonctionnel. Les 4 domaines: Atmosph√©rique (climat), Hydroponique (solution), Nutritionnel (NPK), Photonique (lumi√®re).",
      "gridPos": { "h": 6, "w": 12, "x": 12, "y": 14 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "aeb1b4ee-1f88-42c3-a35a-f594cac90e00" },
      "targets": [{ 
        "rawSql": "SELECT multiIf(sensor_type = 'Temperature', 'üå°Ô∏è Temp√©rature', sensor_type = 'Humidity', 'üí® Humidit√©', sensor_type = 'CO2', 'ü´ß CO2', sensor_type = 'EC', '‚ö° Conductivit√©', sensor_type = 'pH', 'üß™ pH', sensor_type = 'Light_PPFD', '‚òÄÔ∏è Lumi√®re PPFD', sensor_type = 'Nutrient_N', 'ü•¨ Azote (N)', sensor_type = 'Nutrient_P', 'üåø Phosphore (P)', sensor_type = 'Nutrient_K', 'üçÉ Potassium (K)', sensor_type) as Type_Capteur, multiIf(sensor_type IN ('Temperature', 'Humidity', 'CO2'), 'üå°Ô∏è Atmosph√©rique', sensor_type IN ('EC', 'pH'), 'üíß Hydroponique', sensor_type IN ('Nutrient_N', 'Nutrient_P', 'Nutrient_K'), 'üß¨ Nutritionnel', '‚òÄÔ∏è Photonique') as Domaine, count() as Qte, round(avg(health_score), 1) as Sante, round(avg(battery_level), 1) as Batterie, round(avg(signal_strength), 0) as Signal FROM vertiflow.iot_sensors GROUP BY sensor_type ORDER BY Domaine, Sante DESC", 
        "refId": "A", 
        "format": 1 
      }],
      "fieldConfig": { 
        "defaults": { "custom": { "align": "center" } },
        "overrides": [
          { "matcher": { "id": "byName", "options": "Sante" }, "properties": [{ "id": "unit", "value": "percent" }, { "id": "custom.displayMode", "value": "gradient-gauge" }, { "id": "thresholds", "value": { "steps": [{ "color": "red", "value": null }, { "color": "yellow", "value": 70 }, { "color": "green", "value": 90 }] } }, { "id": "min", "value": 0 }, { "id": "max", "value": 100 }] },
          { "matcher": { "id": "byName", "options": "Batterie" }, "properties": [{ "id": "unit", "value": "percent" }, { "id": "custom.displayMode", "value": "gradient-gauge" }, { "id": "thresholds", "value": { "steps": [{ "color": "red", "value": null }, { "color": "orange", "value": 30 }, { "color": "green", "value": 60 }] } }, { "id": "min", "value": 0 }, { "id": "max", "value": 100 }] },
          { "matcher": { "id": "byName", "options": "Signal" }, "properties": [{ "id": "unit", "value": "dBm" }] },
          { "matcher": { "id": "byName", "options": "Domaine" }, "properties": [{ "id": "custom.cellOptions", "value": { "type": "color-background-solid" } }, { "id": "mappings", "value": [{ "type": "value", "options": { "üå°Ô∏è Atmosph√©rique": { "color": "orange", "index": 0 }, "üíß Hydroponique": { "color": "blue", "index": 1 }, "üß¨ Nutritionnel": { "color": "green", "index": 2 }, "‚òÄÔ∏è Photonique": { "color": "yellow", "index": 3 } } }] }] }
        ]
      },
      "options": { "showHeader": true }
    },
    {
      "type": "row",
      "title": "üó∫Ô∏è Carte & Localisation G√©ographique",
      "gridPos": { "h": 1, "w": 24, "x": 0, "y": 20 },
      "collapsed": false
    },
    {
      "type": "geomap",
      "title": "üó∫Ô∏è Carte des Capteurs IoT - Site VertiFlow Casablanca",
      "description": "Visualisation g√©ographique de tous les capteurs IoT d√©ploy√©s sur le site. La taille des marqueurs repr√©sente le score de sant√©, la couleur l'√©tat de connexion. Cliquez sur un capteur pour voir ses d√©tails.",
      "gridPos": { "h": 12, "w": 16, "x": 0, "y": 21 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "aeb1b4ee-1f88-42c3-a35a-f594cac90e00" },
      "targets": [{ 
        "rawSql": "SELECT sensor_id as name, latitude, longitude, health_score as metric, status, zone_id, rack_id, multiIf(sensor_type = 'Temperature', 'Temp√©rature', sensor_type = 'Humidity', 'Humidit√©', sensor_type = 'CO2', 'CO2', sensor_type = 'EC', 'Conductivit√©', sensor_type = 'pH', 'pH', sensor_type = 'Light_PPFD', 'Lumi√®re PPFD', sensor_type = 'Nutrient_N', 'Azote', sensor_type = 'Nutrient_P', 'Phosphore', sensor_type = 'Nutrient_K', 'Potassium', sensor_type) as type_fr FROM vertiflow.iot_sensors", 
        "refId": "A", 
        "format": 1 
      }],
      "options": {
        "view": { "id": "coords", "lat": 33.574, "lon": -7.590, "zoom": 17 },
        "basemap": { "type": "osm-standard", "name": "OpenStreetMap" },
        "layers": [{
          "type": "markers",
          "name": "Capteurs IoT",
          "config": {
            "style": { 
              "size": { "fixed": 10, "min": 5, "max": 20, "field": "metric" }, 
              "color": { "field": "status", "fixed": "green" }, 
              "symbol": { "fixed": "circle", "mode": "fixed" } 
            }
          },
          "location": { "mode": "coords", "latitude": "latitude", "longitude": "longitude" },
          "tooltip": true
        }]
      }
    },
    {
      "type": "table",
      "title": "üìç Coordonn√©es GPS des Capteurs",
      "description": "Liste des capteurs avec leurs coordonn√©es g√©ographiques exactes. Utile pour la localisation physique lors des interventions de maintenance.",
      "gridPos": { "h": 12, "w": 8, "x": 16, "y": 21 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "aeb1b4ee-1f88-42c3-a35a-f594cac90e00" },
      "targets": [{ 
        "rawSql": "SELECT sensor_id as ID, zone_id as Zone, rack_id as Rack, round(latitude, 5) as Latitude, round(longitude, 5) as Longitude, multiIf(status = 'online', 'üü¢ En ligne', status = 'offline', 'üî¥ Hors ligne', status = 'warning', 'üü° Alerte', status = 'error', '‚õî Erreur', 'üîß Maintenance') as Etat FROM vertiflow.iot_sensors ORDER BY zone_id, rack_id, sensor_id", 
        "refId": "A", 
        "format": 1 
      }],
      "fieldConfig": { 
        "defaults": { "custom": { "align": "auto", "displayMode": "auto" } }
      },
      "options": { "showHeader": true }
    },
    {
      "type": "row",
      "title": "üè¢ R√©partition par Zones de Culture",
      "gridPos": { "h": 1, "w": 24, "x": 0, "y": 33 },
      "collapsed": false
    },
    {
      "type": "bargauge",
      "title": "üìä Nombre de Capteurs par Zone",
      "description": "Distribution des capteurs IoT dans chaque zone de culture. Z1=Production A, Z2=Production B, Z3=P√©pini√®re. Un d√©ploiement √©quilibr√© assure une surveillance homog√®ne.",
      "gridPos": { "h": 6, "w": 12, "x": 0, "y": 34 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "aeb1b4ee-1f88-42c3-a35a-f594cac90e00" },
      "targets": [{ 
        "rawSql": "SELECT concat(zone_id, ' - ', multiIf(zone_id = 'Z1', 'Production A', zone_id = 'Z2', 'Production B', zone_id = 'Z3', 'P√©pini√®re', 'Autre')) as Zone, count() as Capteurs FROM vertiflow.iot_sensors GROUP BY zone_id ORDER BY zone_id", 
        "refId": "A", 
        "format": 1 
      }],
      "fieldConfig": { 
        "defaults": { 
          "unit": "short", 
          "color": { "mode": "palette-classic" }, 
          "thresholds": { "steps": [{ "color": "green", "value": null }] } 
        } 
      },
      "options": { "orientation": "horizontal", "displayMode": "gradient", "showUnfilled": true }
    },
    {
      "type": "bargauge",
      "title": "üíö Indice de Sant√© par Zone",
      "description": "Score de sant√© moyen des capteurs pour chaque zone. Un score <70% indique des probl√®mes de connectivit√© ou de maintenance √† investiguer.",
      "gridPos": { "h": 6, "w": 12, "x": 12, "y": 34 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "aeb1b4ee-1f88-42c3-a35a-f594cac90e00" },
      "targets": [{ 
        "rawSql": "SELECT concat(zone_id, ' - ', multiIf(zone_id = 'Z1', 'Production A', zone_id = 'Z2', 'Production B', zone_id = 'Z3', 'P√©pini√®re', 'Autre')) as Zone, round(avg(health_score), 1) as Sante FROM vertiflow.iot_sensors WHERE status != 'offline' GROUP BY zone_id ORDER BY Sante DESC", 
        "refId": "A", 
        "format": 1 
      }],
      "fieldConfig": { 
        "defaults": { 
          "unit": "percent", 
          "min": 0, 
          "max": 100, 
          "thresholds": { 
            "steps": [
              { "color": "red", "value": null }, 
              { "color": "yellow", "value": 70 }, 
              { "color": "green", "value": 90 }
            ] 
          } 
        } 
      },
      "options": { "orientation": "horizontal", "displayMode": "gradient", "showUnfilled": true }
    },
    {
      "type": "table",
      "title": "üìã Tableau de Bord par Zone",
      "description": "Vue consolid√©e de l'√©tat du r√©seau IoT par zone de culture. Suivez le nombre de capteurs par √©tat, la sant√© moyenne et le niveau de batterie pour chaque zone.",
      "gridPos": { "h": 7, "w": 24, "x": 0, "y": 40 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "aeb1b4ee-1f88-42c3-a35a-f594cac90e00" },
      "targets": [{ 
        "rawSql": "SELECT concat(zone_id, ' - ', multiIf(zone_id = 'Z1', 'Production A', zone_id = 'Z2', 'Production B', zone_id = 'Z3', 'P√©pini√®re', 'Autre')) as Zone, count() as Total, countIf(status = 'online') as En_Ligne, countIf(status = 'offline') as Hors_Ligne, countIf(status = 'warning') as Avertissement, countIf(status = 'error') as Erreur, countIf(status = 'maintenance') as Maintenance, round(avg(health_score), 1) as Sante_Moy, round(avg(battery_level), 1) as Batterie_Moy, round(avg(signal_strength), 0) as Signal_Moy FROM vertiflow.iot_sensors GROUP BY zone_id ORDER BY zone_id", 
        "refId": "A", 
        "format": 1 
      }],
      "fieldConfig": { 
        "defaults": { "custom": { "align": "center" } }, 
        "overrides": [
          { "matcher": { "id": "byName", "options": "En_Ligne" }, "properties": [{ "id": "custom.cellOptions", "value": { "type": "color-background" } }, { "id": "color", "value": { "fixedColor": "green", "mode": "fixed" } }] }, 
          { "matcher": { "id": "byName", "options": "Hors_Ligne" }, "properties": [{ "id": "custom.cellOptions", "value": { "type": "color-background" } }, { "id": "color", "value": { "fixedColor": "red", "mode": "fixed" } }] }, 
          { "matcher": { "id": "byName", "options": "Avertissement" }, "properties": [{ "id": "custom.cellOptions", "value": { "type": "color-background" } }, { "id": "color", "value": { "fixedColor": "yellow", "mode": "fixed" } }] }, 
          { "matcher": { "id": "byName", "options": "Erreur" }, "properties": [{ "id": "custom.cellOptions", "value": { "type": "color-background" } }, { "id": "color", "value": { "fixedColor": "dark-red", "mode": "fixed" } }] }, 
          { "matcher": { "id": "byName", "options": "Maintenance" }, "properties": [{ "id": "custom.cellOptions", "value": { "type": "color-background" } }, { "id": "color", "value": { "fixedColor": "orange", "mode": "fixed" } }] }, 
          { "matcher": { "id": "byName", "options": "Sante_Moy" }, "properties": [{ "id": "unit", "value": "percent" }, { "id": "custom.displayMode", "value": "gradient-gauge" }, { "id": "thresholds", "value": { "steps": [{ "color": "red", "value": null }, { "color": "yellow", "value": 70 }, { "color": "green", "value": 90 }] } }, { "id": "min", "value": 0 }, { "id": "max", "value": 100 }] }, 
          { "matcher": { "id": "byName", "options": "Batterie_Moy" }, "properties": [{ "id": "unit", "value": "percent" }, { "id": "custom.displayMode", "value": "gradient-gauge" }, { "id": "thresholds", "value": { "steps": [{ "color": "red", "value": null }, { "color": "orange", "value": 30 }, { "color": "green", "value": 60 }] } }, { "id": "min", "value": 0 }, { "id": "max", "value": 100 }] },
          { "matcher": { "id": "byName", "options": "Signal_Moy" }, "properties": [{ "id": "unit", "value": "dBm" }] }
        ] 
      },
      "options": { "showHeader": true, "footer": { "show": true, "reducer": ["sum"], "countRows": false, "fields": ["Total", "En_Ligne", "Hors_Ligne"] } }
    },
    {
      "type": "row",
      "title": "üóÑÔ∏è R√©partition par Racks de Culture",
      "gridPos": { "h": 1, "w": 24, "x": 0, "y": 47 },
      "collapsed": false
    },
    {
      "type": "bargauge",
      "title": "üìä Nombre de Capteurs par Rack",
      "description": "Distribution des capteurs dans chaque rack de culture. Chaque rack est √©quip√© de capteurs pour surveiller les conditions de croissance au plus pr√®s des plantes.",
      "gridPos": { "h": 6, "w": 12, "x": 0, "y": 48 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "aeb1b4ee-1f88-42c3-a35a-f594cac90e00" },
      "targets": [{ 
        "rawSql": "SELECT concat(zone_id, ' / ', rack_id) as Rack, count() as Capteurs FROM vertiflow.iot_sensors GROUP BY zone_id, rack_id ORDER BY zone_id, rack_id", 
        "refId": "A", 
        "format": 1 
      }],
      "fieldConfig": { 
        "defaults": { 
          "unit": "short", 
          "color": { "mode": "palette-classic" } 
        } 
      },
      "options": { "orientation": "horizontal", "displayMode": "gradient", "showUnfilled": true }
    },
    {
      "type": "bargauge",
      "title": "üíö Indice de Sant√© par Rack",
      "description": "Score de sant√© moyen des capteurs pour chaque rack. Permet d'identifier rapidement les racks avec des probl√®mes de capteurs.",
      "gridPos": { "h": 6, "w": 12, "x": 12, "y": 48 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "aeb1b4ee-1f88-42c3-a35a-f594cac90e00" },
      "targets": [{ 
        "rawSql": "SELECT concat(zone_id, ' / ', rack_id) as Rack, round(avg(health_score), 1) as Sante FROM vertiflow.iot_sensors WHERE status != 'offline' GROUP BY zone_id, rack_id ORDER BY Sante DESC", 
        "refId": "A", 
        "format": 1 
      }],
      "fieldConfig": { 
        "defaults": { 
          "unit": "percent", 
          "min": 0, 
          "max": 100, 
          "thresholds": { 
            "steps": [
              { "color": "red", "value": null }, 
              { "color": "yellow", "value": 70 }, 
              { "color": "green", "value": 90 }
            ] 
          } 
        } 
      },
      "options": { "orientation": "horizontal", "displayMode": "gradient", "showUnfilled": true }
    },
    {
      "type": "table",
      "title": "üìã Tableau de Bord par Rack",
      "description": "Vue d√©taill√©e de l'√©tat du r√©seau IoT par rack de culture. Suivez pr√©cis√©ment l'√©tat de chaque rack pour optimiser les interventions de maintenance.",
      "gridPos": { "h": 7, "w": 24, "x": 0, "y": 54 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "aeb1b4ee-1f88-42c3-a35a-f594cac90e00" },
      "targets": [{ 
        "rawSql": "SELECT zone_id as Zone, rack_id as Rack, count() as Total, countIf(status = 'online') as En_Ligne, countIf(status = 'offline') as Hors_Ligne, countIf(status = 'warning') as Avertissement, countIf(status = 'error') as Erreur, round(avg(health_score), 1) as Sante_Moy, round(avg(battery_level), 1) as Batterie_Moy, round(avg(signal_strength), 0) as Signal_Moy FROM vertiflow.iot_sensors GROUP BY zone_id, rack_id ORDER BY zone_id, rack_id", 
        "refId": "A", 
        "format": 1 
      }],
      "fieldConfig": { 
        "defaults": { "custom": { "align": "center" } }, 
        "overrides": [
          { "matcher": { "id": "byName", "options": "En_Ligne" }, "properties": [{ "id": "custom.cellOptions", "value": { "type": "color-background" } }, { "id": "color", "value": { "fixedColor": "green", "mode": "fixed" } }] }, 
          { "matcher": { "id": "byName", "options": "Hors_Ligne" }, "properties": [{ "id": "custom.cellOptions", "value": { "type": "color-background" } }, { "id": "color", "value": { "fixedColor": "red", "mode": "fixed" } }] }, 
          { "matcher": { "id": "byName", "options": "Avertissement" }, "properties": [{ "id": "custom.cellOptions", "value": { "type": "color-background" } }, { "id": "color", "value": { "fixedColor": "yellow", "mode": "fixed" } }] }, 
          { "matcher": { "id": "byName", "options": "Erreur" }, "properties": [{ "id": "custom.cellOptions", "value": { "type": "color-background" } }, { "id": "color", "value": { "fixedColor": "dark-red", "mode": "fixed" } }] }, 
          { "matcher": { "id": "byName", "options": "Sante_Moy" }, "properties": [{ "id": "unit", "value": "percent" }, { "id": "custom.displayMode", "value": "gradient-gauge" }, { "id": "thresholds", "value": { "steps": [{ "color": "red", "value": null }, { "color": "yellow", "value": 70 }, { "color": "green", "value": 90 }] } }, { "id": "min", "value": 0 }, { "id": "max", "value": 100 }] }, 
          { "matcher": { "id": "byName", "options": "Batterie_Moy" }, "properties": [{ "id": "unit", "value": "percent" }, { "id": "custom.displayMode", "value": "gradient-gauge" }, { "id": "thresholds", "value": { "steps": [{ "color": "red", "value": null }, { "color": "orange", "value": 30 }, { "color": "green", "value": 60 }] } }, { "id": "min", "value": 0 }, { "id": "max", "value": 100 }] },
          { "matcher": { "id": "byName", "options": "Signal_Moy" }, "properties": [{ "id": "unit", "value": "dBm" }] }
        ] 
      },
      "options": { "showHeader": true }
    },
    {
      "type": "row",
      "title": "üì° Inventaire Complet des Capteurs",
      "gridPos": { "h": 1, "w": 24, "x": 0, "y": 61 },
      "collapsed": false
    },
    {
      "type": "table",
      "title": "üìã Liste Compl√®te des Capteurs IoT",
      "description": "Inventaire exhaustif de tous les capteurs d√©ploy√©s avec leurs caract√©ristiques techniques: type de mesure, localisation, √©tat de connexion, score de sant√©, niveau de batterie et qualit√© du signal. Utilisez les filtres pour rechercher un capteur sp√©cifique.",
      "gridPos": { "h": 10, "w": 24, "x": 0, "y": 62 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "aeb1b4ee-1f88-42c3-a35a-f594cac90e00" },
      "targets": [{ 
        "rawSql": "SELECT sensor_id as ID, multiIf(sensor_type IN ('Temperature', 'Humidity', 'CO2'), 'üå°Ô∏è Atmosph√©rique', sensor_type IN ('EC', 'pH'), 'üíß Hydroponique', sensor_type IN ('Nutrient_N', 'Nutrient_P', 'Nutrient_K'), 'üß¨ Nutritionnel', '‚òÄÔ∏è Photonique') as Domaine, multiIf(sensor_type = 'Temperature', 'üå°Ô∏è Temp√©rature', sensor_type = 'Humidity', 'üí® Humidit√©', sensor_type = 'CO2', 'ü´ß CO2', sensor_type = 'EC', '‚ö° Conductivit√©', sensor_type = 'pH', 'üß™ pH', sensor_type = 'Light_PPFD', '‚òÄÔ∏è PPFD', sensor_type = 'Nutrient_N', 'ü•¨ Azote', sensor_type = 'Nutrient_P', 'üåø Phosphore', sensor_type = 'Nutrient_K', 'üçÉ Potassium', sensor_type) as Type, zone_id as Zone, rack_id as Rack, multiIf(status = 'online', 'üü¢ En ligne', status = 'offline', 'üî¥ Hors ligne', status = 'warning', 'üü° Alerte', status = 'error', '‚õî Erreur', 'üîß Maintenance') as Etat, round(health_score, 1) as Sante, round(battery_level, 1) as Batterie, signal_strength as Signal, firmware_version as Firmware FROM vertiflow.iot_sensors ORDER BY Domaine, zone_id, rack_id", 
        "refId": "A", 
        "format": 1 
      }],
      "fieldConfig": { 
        "defaults": { "custom": { "align": "auto", "filterable": true } }, 
        "overrides": [
          { "matcher": { "id": "byName", "options": "Sante" }, "properties": [{ "id": "unit", "value": "percent" }, { "id": "custom.displayMode", "value": "gradient-gauge" }, { "id": "thresholds", "value": { "steps": [{ "color": "red", "value": null }, { "color": "yellow", "value": 70 }, { "color": "green", "value": 90 }] } }, { "id": "min", "value": 0 }, { "id": "max", "value": 100 }] }, 
          { "matcher": { "id": "byName", "options": "Batterie" }, "properties": [{ "id": "unit", "value": "percent" }, { "id": "custom.displayMode", "value": "gradient-gauge" }, { "id": "thresholds", "value": { "steps": [{ "color": "red", "value": null }, { "color": "orange", "value": 30 }, { "color": "green", "value": 60 }] } }, { "id": "min", "value": 0 }, { "id": "max", "value": 100 }] }, 
          { "matcher": { "id": "byName", "options": "Signal" }, "properties": [{ "id": "unit", "value": "dBm" }, { "id": "thresholds", "value": { "steps": [{ "color": "red", "value": null }, { "color": "yellow", "value": -70 }, { "color": "green", "value": -50 }] } }] }
        ] 
      },
      "options": { "showHeader": true, "footer": { "show": true, "reducer": ["count"], "countRows": true } }
    },
    {
      "type": "row",
      "title": "‚ö†Ô∏è Alertes & Capteurs N√©cessitant une Intervention",
      "gridPos": { "h": 1, "w": 24, "x": 0, "y": 72 },
      "collapsed": false
    },
    {
      "type": "table",
      "title": "üö® Capteurs en Alerte",
      "description": "Liste des capteurs n√©cessitant une attention imm√©diate: hors ligne, en erreur, en avertissement ou avec une batterie faible (<60%). Priorisez les interventions selon la criticit√©.",
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 73 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "aeb1b4ee-1f88-42c3-a35a-f594cac90e00" },
      "targets": [{ 
        "rawSql": "SELECT sensor_id as ID_Capteur, multiIf(sensor_type = 'Temperature', 'üå°Ô∏è Temp', sensor_type = 'Humidity', 'üí® Hum', sensor_type = 'CO2', 'ü´ß CO2', sensor_type = 'EC', '‚ö° EC', sensor_type = 'pH', 'üß™ pH', sensor_type = 'Light_PPFD', '‚òÄÔ∏è Lux', sensor_type = 'Nutrient_N', 'ü•¨ N', sensor_type = 'Nutrient_P', 'üåø P', sensor_type = 'Nutrient_K', 'üçÉ K', sensor_type) as Type, zone_id as Zone, rack_id as Rack, multiIf(status = 'online', 'üü¢ En ligne', status = 'offline', 'üî¥ Hors ligne', status = 'warning', 'üü° Alerte', status = 'error', '‚õî Erreur', 'üîß Maintenance') as Etat, round(health_score, 1) as Sante, round(battery_level, 1) as Batterie, multiIf(status = 'error', 'üî¥ CRITIQUE', status = 'offline', 'üü† URGENT', status = 'warning', 'üü° MOD√âR√â', battery_level < 30, 'üîã BATTERIE', '‚ö†Ô∏è AVERTISSEMENT') as Priorite FROM vertiflow.iot_sensors WHERE status IN ('offline', 'error', 'warning') OR battery_level < 60 ORDER BY CASE status WHEN 'error' THEN 1 WHEN 'offline' THEN 2 WHEN 'warning' THEN 3 ELSE 4 END, battery_level ASC", 
        "refId": "A", 
        "format": 1 
      }],
      "fieldConfig": { 
        "defaults": { "custom": { "align": "auto" } }, 
        "overrides": [
          { "matcher": { "id": "byName", "options": "Sante" }, "properties": [{ "id": "unit", "value": "percent" }, { "id": "custom.displayMode", "value": "gradient-gauge" }, { "id": "thresholds", "value": { "steps": [{ "color": "red", "value": null }, { "color": "yellow", "value": 70 }, { "color": "green", "value": 90 }] } }, { "id": "min", "value": 0 }, { "id": "max", "value": 100 }] }, 
          { "matcher": { "id": "byName", "options": "Batterie" }, "properties": [{ "id": "unit", "value": "percent" }, { "id": "custom.displayMode", "value": "gradient-gauge" }, { "id": "thresholds", "value": { "steps": [{ "color": "red", "value": null }, { "color": "orange", "value": 30 }, { "color": "yellow", "value": 60 }] } }, { "id": "min", "value": 0 }, { "id": "max", "value": 100 }] },
          { "matcher": { "id": "byName", "options": "Priorite" }, "properties": [{ "id": "custom.cellOptions", "value": { "type": "color-background-solid" } }, { "id": "mappings", "value": [{ "type": "value", "options": { "üî¥ CRITIQUE": { "color": "dark-red", "index": 0 }, "üü† URGENT": { "color": "red", "index": 1 }, "üü° MOD√âR√â": { "color": "yellow", "index": 2 }, "üîã BATTERIE": { "color": "orange", "index": 3 }, "‚ö†Ô∏è AVERTISSEMENT": { "color": "yellow", "index": 4 } } }] }] }
        ] 
      },
      "options": { "showHeader": true }
    },
    {
      "type": "table",
      "title": "üîã Batteries √† Remplacer",
      "description": "Liste des capteurs dont la batterie est inf√©rieure √† 60%. Planifiez le remplacement avant que le niveau ne devienne critique (<30%).",
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 73 },
      "datasource": { "type": "grafana-clickhouse-datasource", "uid": "aeb1b4ee-1f88-42c3-a35a-f594cac90e00" },
      "targets": [{ 
        "rawSql": "SELECT sensor_id as ID_Capteur, multiIf(sensor_type = 'Temperature', 'üå°Ô∏è Temp√©rature', sensor_type = 'Humidity', 'üí® Humidit√©', sensor_type = 'CO2', 'ü´ß CO2', sensor_type = 'EC', '‚ö° Conductivit√©', sensor_type = 'pH', 'üß™ pH', sensor_type = 'Light_PPFD', '‚òÄÔ∏è Lumi√®re', sensor_type = 'Nutrient_N', 'ü•¨ Azote', sensor_type = 'Nutrient_P', 'üåø Phosphore', sensor_type = 'Nutrient_K', 'üçÉ Potassium', sensor_type) as Type, zone_id as Zone, rack_id as Rack, round(battery_level, 1) as Batterie, multiIf(status = 'online', 'üü¢ En ligne', status = 'offline', 'üî¥ Hors ligne', status = 'warning', 'üü° Alerte', status = 'error', '‚õî Erreur', 'üîß Maintenance') as Etat, multiIf(battery_level < 20, 'üî¥ CRITIQUE', battery_level < 40, 'üü† URGENT', battery_level < 60, 'üü° √Ä PLANIFIER', '‚úÖ OK') as Urgence FROM vertiflow.iot_sensors WHERE battery_level < 100 AND battery_level > 0 ORDER BY battery_level ASC", 
        "refId": "A", 
        "format": 1 
      }],
      "fieldConfig": { 
        "defaults": { "custom": { "align": "auto" } }, 
        "overrides": [
          { "matcher": { "id": "byName", "options": "Batterie" }, "properties": [{ "id": "unit", "value": "percent" }, { "id": "custom.displayMode", "value": "gradient-gauge" }, { "id": "thresholds", "value": { "steps": [{ "color": "red", "value": null }, { "color": "orange", "value": 30 }, { "color": "yellow", "value": 50 }, { "color": "green", "value": 80 }] } }, { "id": "min", "value": 0 }, { "id": "max", "value": 100 }] },
          { "matcher": { "id": "byName", "options": "Urgence" }, "properties": [{ "id": "custom.cellOptions", "value": { "type": "color-background-solid" } }, { "id": "mappings", "value": [{ "type": "value", "options": { "üî¥ CRITIQUE": { "color": "dark-red", "index": 0 }, "üü† URGENT": { "color": "orange", "index": 1 }, "üü° √Ä PLANIFIER": { "color": "yellow", "index": 2 }, "‚úÖ OK": { "color": "green", "index": 3 } } }] }] }
        ] 
      },
      "options": { "showHeader": true }
    }
  ],
  "refresh": "30s",
  "schemaVersion": 38,
  "tags": ["iot", "capteurs", "sant√©", "carte", "zones", "racks", "maintenance", "vertiflow"],
  "templating": { 
    "list": [
      {
        "name": "zone",
        "label": "Zone de Culture",
        "type": "query",
        "datasource": { "type": "grafana-clickhouse-datasource", "uid": "aeb1b4ee-1f88-42c3-a35a-f594cac90e00" },
        "query": "SELECT DISTINCT zone_id FROM vertiflow.iot_sensors ORDER BY zone_id",
        "refresh": 2,
        "multi": true,
        "includeAll": true,
        "current": { "selected": true, "text": "All", "value": "$__all" }
      },
      {
        "name": "sensor_type",
        "label": "Type de Capteur",
        "type": "query",
        "datasource": { "type": "grafana-clickhouse-datasource", "uid": "aeb1b4ee-1f88-42c3-a35a-f594cac90e00" },
        "query": "SELECT DISTINCT sensor_type FROM vertiflow.iot_sensors ORDER BY sensor_type",
        "refresh": 2,
        "multi": true,
        "includeAll": true,
        "current": { "selected": true, "text": "All", "value": "$__all" }
      }
    ] 
  },
  "time": { "from": "now-24h", "to": "now" },
  "timepicker": {
    "refresh_intervals": ["5s", "10s", "30s", "1m", "5m"],
    "time_options": ["5m", "15m", "1h", "6h", "12h", "24h", "2d", "7d"]
  },
  "timezone": "browser",
  "title": "09 - IoT Sant√© & Carte des Capteurs",
  "uid": "vertiflow-iot-health",
  "version": 1,
  "weekStart": ""
}
